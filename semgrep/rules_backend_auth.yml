rules:
  - id: hardcoded-jwt-secret
    patterns:
      - pattern: '"insecure-default-change-me"'
    message: >-
      Wykryto domyślny, niebezpieczny sekret JWT. Należy go zmienić w środowisku produkcyjnym,
      ustawiając zmienną środowiskową JWT_SECRET.
    languages:
      - python
    severity: ERROR
    metadata:
      category: security
      confidence: HIGH
      technology:
        - fastapi
        - jwt

  - id: broad-exception-disclosure
    patterns:
      - pattern-inside: |
          try:
            ...
          except Exception as $E:
            ...
      - pattern: fastapi.HTTPException(..., detail=str($E), ...)
    message: >-
      Przechwytywanie ogólnego wyjątku `Exception` i zwracanie jego treści w odpowiedzi HTTP
      może prowadzić do wycieku wrażliwych informacji. Zamiast tego należy logować szczegóły
      błędu i zwracać ogólny komunikat.
    languages:
      - python
    severity: WARNING
    metadata:
      category: security
      confidence: HIGH
      cwe: "CWE-209: Generation of Error Message Containing Sensitive Information"
      technology:
        - fastapi

  - id: insecure-dependency-require-auth
    patterns:
      - pattern: fastapi.Depends(server.security.require_auth)
    message: >-
      Wykryto użycie zależności 'require_auth', która weryfikuje tylko token JWT,
      ale nie sprawdza podpisu HMAC żądania. Może to być niebezpieczne w przypadku
      endpointów API, które powinny używać 'require_session_and_signed_request'
      do pełnej weryfikacji. Używaj 'require_auth' tylko wtedy, gdy jest to świadoma
      decyzja (np. dla publicznych endpointów dokumentacji).
    languages:
      - python
    severity: WARNING
    metadata:
      category: security
      confidence: MEDIUM
      technology:
        - fastapi


